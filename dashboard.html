<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | AI Micro-Tutor</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .user-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1em 2em;
      background: white;
      margin-bottom: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: #e5e5e5;
      border-radius: 4px;
      margin: 10px 0;
    }
    .progress-fill {
      height: 100%;
      background: #4f46e5;
      border-radius: 4px;
      transition: width 0.3s;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1em;
      margin-bottom: 2em;
    }
    .stat-card {
      padding: 1.5em;
      background: white;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .stat-number {
      font-size: 2em;
      font-weight: bold;
      color: #4f46e5;
    }
    .premium-banner {
      background: linear-gradient(45deg, #fbbf24, #f59e0b);
      color: white;
      padding: 1em;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 1em;
    }
    .limit-warning {
      color: #dc2626;
      font-size: 14px;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <h1 class="logo">AI Micro-Tutor</h1>
    <div class="nav-buttons">
      <span id="user-welcome">Welcome!</span>
      <a href="#" onclick="logout()" class="btn">Logout</a>
    </div>
  </nav>

  <div id="premium-banner" class="premium-banner" style="display: none;">
    <h3>🚀 Upgrade to Premium</h3>
    <p>Unlock unlimited lessons and advanced features!</p>
    <button onclick="upgradeToPremium()" class="btn">Upgrade Now - $9.99/mo</button>
  </div>

  <div class="dashboard">
    <div class="user-info">
      <div>
        <h3 id="user-name">User Dashboard</h3>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
        <span id="progress-text">0% Complete</span>
      </div>
      <div>
        <span id="plan-badge" class="premium-badge">Free Plan</span>
        <p id="lessons-remaining">3 lessons remaining today</p>
      </div>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-number" id="lessons-completed">0</div>
        <p>Lessons Completed</p>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="quizzes-taken">0</div>
        <p>Quizzes Taken</p>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="current-streak">0</div>
        <p>Day Streak</p>
      </div>
    </div>

    <h2>Select a Topic</h2>
    <div class="topics">
      <div class="card" onclick="selectTopic('English Grammar')">
        <h3>English Grammar</h3>
        <p>Improve your writing and speaking skills.</p>
        <div class="topic-progress">Progress: <span id="grammar-progress">0%</span></div>
      </div>
      <div class="card" onclick="selectTopic('Basic Coding')">
        <h3>Basic Coding</h3>
        <p>Learn the fundamentals of programming.</p>
        <div class="topic-progress">Progress: <span id="coding-progress">0%</span></div>
      </div>
      <div class="card" onclick="selectTopic('Math Basics')">
        <h3>Math Basics</h3>
        <p>Strengthen your foundation in mathematics.</p>
        <div class="topic-progress">Progress: <span id="math-progress">0%</span></div>
      </div>
      <div class="card premium-only" onclick="selectTopic('Advanced Topics')">
        <h3>Advanced Topics 🔒</h3>
        <p>Premium feature - Unlock with upgrade</p>
        <div class="topic-progress">Premium Only</div>
      </div>
    </div>

    <div class="reminders-section">
      <h3>Study Reminders</h3>
      <div class="reminder-controls">
        <input type="time" id="reminder-time" value="18:00">
        <button onclick="setReminder()" class="btn">Set Daily Reminder</button>
        <span id="reminder-status"></span>
      </div>
    </div>
  </div>

  <script>
    // Load user data and initialize dashboard
    function initDashboard() {
      const user = JSON.parse(sessionStorage.getItem("user") || "{}");
      const progress = JSON.parse(localStorage.getItem("userProgress") || "{}");
      
      console.log("Dashboard - User data:", user); // Debug log
      
      if (!user.email) {
        console.log("No user found, redirecting to login");
        window.location.href = "login.html";
        return;
      }

      // Update user display elements
      const welcomeEl = document.getElementById("user-welcome");
      const nameEl = document.getElementById("user-name");
      
      if (welcomeEl) {
        welcomeEl.textContent = `Welcome, ${user.fullName || user.email}!`;
      }
      
      if (nameEl) {
        nameEl.textContent = `${user.fullName || 'User'}'s Dashboard`;
      }
      
      // Update plan badge and premium banner
      const planBadge = document.getElementById("plan-badge");
      const premiumBanner = document.getElementById("premium-banner");
      
      if (planBadge) {
        if (user.plan === 'premium') {
          planBadge.textContent = "Premium ⭐";
          planBadge.style.background = "#10b981";
          planBadge.style.color = "white";
          if (premiumBanner) premiumBanner.style.display = "none";
        } else {
          planBadge.textContent = "Free Plan";
          planBadge.style.background = "#6b7280";
          planBadge.style.color = "white";
          if (premiumBanner) premiumBanner.style.display = "block";
        }
      }

      // Update daily lesson count
      const today = new Date().toDateString();
      const dailyCount = progress.dailyLessons?.[today] || 0;
      const remaining = user.plan === 'premium' ? 'Unlimited' : Math.max(0, 3 - dailyCount);
      document.getElementById("lessons-remaining").textContent = 
        user.plan === 'premium' ? 'Unlimited lessons' : `${remaining} lessons remaining today`;

      // Update stats
      document.getElementById("lessons-completed").textContent = progress.totalLessons || 0;
      document.getElementById("quizzes-taken").textContent = progress.totalQuizzes || 0;
      document.getElementById("current-streak").textContent = progress.currentStreak || 0;

      // Update progress bar
      const totalProgress = Math.min(100, (progress.totalLessons || 0) * 10);
      document.getElementById("progress-fill").style.width = totalProgress + "%";
      document.getElementById("progress-text").textContent = totalProgress + "% Complete";

      // Update topic progress
      document.getElementById("grammar-progress").textContent = (progress.topics?.grammar || 0) + "%";
      document.getElementById("coding-progress").textContent = (progress.topics?.coding || 0) + "%";
      document.getElementById("math-progress").textContent = (progress.topics?.math || 0) + "%";

      // Show limit warning if needed
      if (user.plan !== 'premium' && dailyCount >= 3) {
        const warning = document.createElement('p');
        warning.className = 'limit-warning';
        warning.textContent = 'Daily limit reached. Upgrade to Premium for unlimited access!';
        document.querySelector('.dashboard').prepend(warning);
      }
    }

    function selectTopic(topic) {
      const user = JSON.parse(sessionStorage.getItem("user") || "{}");
      const progress = JSON.parse(localStorage.getItem("userProgress") || "{}");
      const today = new Date().toDateString();
      const dailyCount = progress.dailyLessons?.[today] || 0;

      // Check premium features
      if (topic === 'Advanced Topics' && user.plan !== 'premium') {
        alert('This is a premium feature. Please upgrade to access advanced topics!');
        return;
      }

      // Check daily limits for free users
      if (user.plan !== 'premium' && dailyCount >= 3) {
        alert('You have reached your daily limit of 3 lessons. Upgrade to Premium for unlimited access!');
        return;
      }

      sessionStorage.setItem("selectedTopic", topic);
      window.location.href = "lesson.html";
    }

    function setReminder() {
      const time = document.getElementById("reminder-time").value;
      if (time) {
        localStorage.setItem("reminderTime", time);
        document.getElementById("reminder-status").textContent = `Reminder set for ${time}`;
        
        // In a real app, you'd set up push notifications here
        if ("Notification" in window) {
          Notification.requestPermission();
        }
      }
    }

    function upgradeToPremium() {
      // In production, integrate with payment processor
      const confirmed = confirm("Redirect to payment page?\n\nPremium features:\n• Unlimited lessons\n• Advanced topics\n• Detailed analytics\n• Priority support");
      
      if (confirmed) {
        // Mock premium upgrade
        const user = JSON.parse(sessionStorage.getItem("user") || "{}");
        user.plan = 'premium';
        sessionStorage.setItem("user", JSON.stringify(user));
        alert("Welcome to Premium! 🎉");
        location.reload();
      }
    }

    function logout() {
      sessionStorage.clear();
      localStorage.removeItem("userProgress");
      window.location.href = "index.html";
    }

    // Initialize dashboard on load
    window.onload = initDashboard;
  </script>
</body>
</html>